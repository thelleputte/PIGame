<!DOCTYPE html>
<html lang="fr">

<head>

	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"> -->
	<meta name="description" content="My first mockup of PIGame" />
	<meta name="author" content="The geeks du dimanche">
	<link rel="icon" href="img/pig_pixel.png">

	<title>PIGame mockup1</title>

	<!-- Bootstrap core CSS -->
	<link href="dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Custom styles for this template -->
	<link href="pig.css" rel="stylesheet">

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug 
    <link href="assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">
-->

<!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
<!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]
    <script src="../../assets/js/ie-emulation-modes-warning.js"></script>
-->

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->

<!--  For PhoneGap build
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
-->

<style type="text/css">
	body{
		background-color: lightgrey;
	}

	h1:hover{
		text-shadow: 0px 0px 20px blue;
	}

	.glow{
		text-shadow: 0px 0px 20px blue;
	}

	.hidden {
		display: none;
	}

	.progress-bar-perso {
		background-color: pink;
	}

	img{
		width: 48px;
		cursor: pointer;
		/*padding: 10px;*/
		/* border:1px solid #fff;*/
		margin-right: 20px;
	}

	img:hover{
		-webkit-border-radius: 10px;
		-moz-border-radius: 10px;
		border-radius: 10px;
		-webkit-box-shadow: 0px 0px 30px 0px rgba(0, 255, 0, 0.67);
		-moz-box-shadow:    0px 0px 30px 0px rgba(0, 255, 0, 0.67);
		box-shadow:         0px 0px 30px 0px rgba(0, 255, 0, 0.67);
	}
	img:last-of-type:hover{
		-webkit-border-radius: 10px;
		-moz-border-radius: 10px;
		border-radius: 10px;
		-webkit-box-shadow: 0px 0px 30px 0px rgba(232, 0, 0, 0.67);
		-moz-box-shadow:    0px 0px 30px 0px rgba(232, 0, 0, 0.67);
		box-shadow:         0px 0px 30px 0px rgba(232, 0, 0, 0.67);
	}
</style>

</head>

<body>

	<nav class="navbar navbar-pigame navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span> 
					<span class="icon-bar"></span> 
					<span class="icon-bar"></span> 
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#"> 
				<!-- <span class="glyphicon glyphicon-eye-open"></span>-->
				PIGame
				</a>
			</div>
			<div id="navbar" class="collapse navbar-collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="#">Scores</a></li>
					<li><a href="#about">Questions</a></li>
					<li><a href="#contact">Contact</a></li>
				</ul>
			</div>
			<!--/.nav-collapse -->
		</div>
	</nav>

	<div class="container">
		<div class="jumbotron">
			<div class="collapse in qFrame" id="answerButtons">		
				<h1>Hello Girls!</h1>
			</div>
			<!--<div id="question"></div>-->					
			<p class="lead" id="question">Prêtes à jouer ?</p>
			<p class="lead" id="answer"></p>
			<div class="row collapse qFrame" id="answerButtons">
				<div class="col-xs-3">
					<input type="button" class="btn btn-lg btn-block btn-success" id="correct" value="Correct" onclick="correct()" />
				</div>
				<div class="col-xs-3">
					<input type="button" class="btn btn-lg btn-block btn-danger" id="incorrect" value="Incorrect" onclick="incorrect()" />
				</div>
			</div>						
		</div>
	</div>
	<!-- /.container -->

	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<div id="some_div"></div>
			</div>
		</div>
	</div>

	<div class="container">
		<section class="row">
			<div class="col-xs-2">
				<div id="player1" class="hidden" onClick="this.contentEditable='true';">Player1</div>
			</div>
			<div class="col-xs-10">
				<div id="pg1" class="progress progress-striped active hidden">
					<div id="pb1" class="progress-bar"></div>
					<div id="pourcentage" class="pull-right"></div>
				</div>
			</div>
			<div class="col-xs-2">
				<p id="player2" class="hidden">Player2</p>
			</div>
			<div class="col-xs-10">
				<div id="pg2" class="progress progress-striped active hidden">
					<div id="pb2" class="progress-bar progress-bar-danger"></div>
					<div id="pourcentage" class="pull-right"></div>
				</div>
			</div>
			<div class="col-xs-2">
				<p id="player3" class="hidden">Player3</p>
			</div>
			<div class="col-xs-10">
				<div id="pg3" class="progress progress-striped active hidden">
					<div id="pb3" class="progress-bar progress-bar-warning"></div>
					<div id="pourcentage" class="pull-right"></div>
				</div>
			</div>
			<div class="col-xs-2">
				<p id="player4" class="hidden">Player4</p>
			</div>
			<div class="col-xs-10">
				<div id="pg4" class="progress progress-striped active hidden">
					<div id="pb4" class="progress-bar progress-bar-perso"></div>
					<div id="pourcentage" class="pull-right"></div>
				</div>
			</div>
			<div class="col-xs-2">
				<p id="player5" class="hidden">Player5</p>
			</div>
			<div class="col-xs-10">
				<div id="pg5" class="progress progress-striped active hidden">
					<div id="pb5" class="progress-bar progress-bar-success"></div>
					<div id="pourcentage" class="pull-right"></div>
				</div>
			</div>
			<div class="col-xs-2">
				<p id="player6" class="hidden">Player6</p>
			</div>
			<div class="col-xs-10">
				<div id="pg6" class="progress progress-striped active hidden">
					<div id="pb6" class="progress-bar progress-bar-info"></div>
					<div id="pourcentage" class="pull-right"></div>
				</div>
			</div>
			<div class="col-xs-offset-1">
				<!-- No need anymore 
				<input type="button" class="btn btn-primary" id="animer" value="Animer" />
                                -->
			</div>
		</section>
	</div>

	<br>

	<div class="container">
		<div class="row">		
			<div class="col-xs-12">
				<button class="btn btn-primary" id="startStop" data-toggle="collapse" data-target=".qFrame" onclick="startGame()">Débuter le jeu</button>
				<!--<button class="btn btn-primary" id="startStop" data-toggle="collapse" data-target="#answerButtons" onclick="startGame()">Débuter le jeu</button>-->
				<!--<input type="button" class="btn btn-primary" id="start" value="Débuter le jeu" onclick="getQuestion()" />-->
				<input type="button" class="btn btn-primary hidden" id="nextQ" value="Autre question" onclick="nextQ()" />				
			</div>
		</div>
	</div>

	<br>

	<div class="container">	
		<div class="col-xs-12">
			<div id="result"></div>
		</div>
		<div class="col-xs-12">
			<div id="console">
				<br>
			</div>
		</div>		
	</div>



	<a href="#user"  data-toggle="modal"  data-id="{$user['id']}">ModalTest</a>

	<div class="modal fade" id="user">
	    <div class="modal-header">
	        <button class="close" data-dismiss="modal">×</button>
	        <h3>Modal header</h3>
	    </div>
	    <div class="modal-body">
	        <p>Some code</p>
	    </div>
	</div>


	
	<script src="dist/js/jquery.js"></script>

	<script type="text/javascript">
		// Catch any button click
	    $(document).ready(function(){
	        $("button").click(function(){
	            /*
	            $.ajax({
	                type: 'POST',
	                url: 'your_page.php',
	                success: function(data) {
	                    alert(data);
	                    $("p").text(data);

	                }
	            });
	            //other method, also ajax
		        var clickBtnValue = $(this).val();
		        var ajaxurl = 'your_page.php',
		        data =  {'action': clickBtnValue};
		        $.post(ajaxurl, data, function (response) {
		            // Response div goes here.
		            alert("action performed successfully");
		        });
		        */	            
		   });
		});
		
		//right way of doing a sleep
		//use of asynchronous function
		//await can only be executed in functions prefixed with the async keyword. Runkit wraps your code in an async function before executing it. 
		//await only pauses the current async function
		//the async/await feature lets the code explicitly wait for a promise to settle
		//note tha promises are not supported by IE (tiens tiens..)

		function sleep(ms) {
  			return new Promise(resolve => setTimeout(resolve, ms));
		}
		/*
		async function sleepDemo() {
			console.log('Taking a break...');
			await sleep(2000);
			console.log('Two second later');
		}
		*/		
		
	</script>
	


	<script>

	var currentQuestion = "";
	var currentAnswer = "";	
	var currentPlayerID = 0;

		function getDate(){
			var currentdate = new Date(); 
			var datetime = currentdate.getDate() + "/"
			             + (currentdate.getMonth()+1)  + "/" 
			             + currentdate.getFullYear() + " @ "  
			             + currentdate.getHours() + ":"  
			             + currentdate.getMinutes() + ":" 
			             + currentdate.getSeconds();
			 return datetime;

		}

		function getQuestion(){
			//show answers buttons (de-activated)
			$("#answerButtons").toggle();
			$("#correct").prop('disabled', true);
			$("#incorrect").prop('disabled', true);			
			alert ("le reste est à implémenter :)");
		}		

		function startGame(){
		//start directly at load of the page
			document.getElementById("question").innerHTML = "Allez-y, tapez vos boutons..";
			document.getElementById("startStop").innerHTML = "Arrêter le jeu";
			document.getElementById("startStop").onclick = stopGame;	

			//de-activate answers buttons
			$("#correct").prop('disabled', true);
			$("#incorrect").prop('disabled', true);
			//$(".hidden").removeClass("hidden");

			startListeners('all');
		}

		function stopGame() {
			$("#startStop").prop('disabled', true);
			$("#nextQ").prop('disabled', true);
			$("#correct").prop('disabled', true);
			$("#incorrect").prop('disabled', true);
			$(".progress").removeClass("active");
		}			

		function closeConnection(source) {			

			source.close();
			//logger.log('> Connection was closed');
			//updateConnectionStatus('Disconnected', false);
			document.getElementById("result").innerHTML += "Connection arrêtée<br>";
		}	

		function startListeners(mode = "all"){	

			console.log("start " + mode + " listeners");
			
			//Events listener initiation

			if(typeof(EventSource) !== "undefined") {
				console.log("listening pig.php");
				//var source = new EventSource("http://192.168.1.50:10000");
				/* this will work on any machine if the game and the webserver are on the same machine which is generally the case */
				var source = new EventSource("http://"+document.location.hostname+":10000/"); 
			} else {
				console.log("Browser does not support Server Sent Events");
				document.getElementById("result").innerHTML = "Désolé, ce jeu est beaucoup trop trendy. Votre navigateur ne le supporte pas.";
			}

			//Events listener start
			switch (mode) {
				case "all":
					listenStatus(source); 
					listenQuestion(source);
					listenPlayer(source);
					break;
			    case "question":
					listenQuestion(source);
					break;
			    case "player":
					listenPlayer(source);
					break;
				case "status":
					listenStatus(source);
					break;
    			default:
					listenStatus(source);    			
					listenQuestion(source);
					listenPlayer(source);
			}			

		}
		
		async function listenStatus(source){
			// Event listener for status
			console.log("Listening for status..");	
			// in JSON format
			source.addEventListener("status", function(event) {
			  console.log("status message to parse: " + event.data);
			  var data = JSON.parse(event.data);
			  console.log("Status: " + data["state"],"Players: " + data["player names"],"Scores: " + data["scores"]);
			  //each message contains the lastEventId property
			  console.log("Last id: " + event.lastEventId);
			  /*
				@Nikos Most of the interface display logic should be done here depending on the 
				state received in the status message.
				The score update should also apply here from the score field of the status message
				=> use updateScore(player_id, score)
			  */
			  //update the scores from incomming status message
			  for (i in data["player ids"]){
				//console.log("player id = "+data["player ids"][i]);
				updateScore(parseInt(data["player ids"][i])+1,data["scores"][i]);
			  }
			  //set player names
			  for (i in data["player ids"]){
				player=parseInt(data["player ids"][i])+1;
				$("#player"+player).removeClass("hidden");
				$("#pg"+player).removeClass("hidden");
				document.getElementById("player"+player).innerHTML = data["player names"][i];
				//await sleep(1000);
				//sleep(1000);
			  }			  
			  if (data["state"] == "wait_for_answer_ack"){
				//activate answers buttons
				$("#correct").prop('disabled', false);
				$("#incorrect").prop('disabled', false);
			  }
			}, false);
		}
		
		function listenMessage(source){
			// Event listener for general message
			console.log("Listening for message..");			

			//source.onmessage = function(event) {
			//	document.getElementById("result").innerHTML += event.data + "<br>";
			//};
			//same, but with different listeners
			/*
			source.addEventListener("message",function(event){
				document.getElementById("result").innerHTML += event.data + "<br>";
			}, false);
			source.addEventListener("question",function(event){
				document.getElementById("question").innerHTML += event.data + "<br>";
			}, false);
			*/

			// in JSON format
			source.addEventListener("message", function(event) {
			  var data = JSON.parse(event.data);
			  //considering two vars, id & msg
			  console.log(data.id, data.msg);
			  //each message contains the lastEventId property
			  console.log(event.lastEventId);
			}, false);
		}

		function listenQuestion(source){
			// Event listener for question
			console.log("Listening for next question..");

			source.addEventListener("question",function(event){

				document.getElementById("result").innerHTML = "Last browser Question sync: " + getDate() + "<br>";
				document.getElementById("result").innerHTML += "Question last ID: " + event.lastEventId + "<br>";

				//var currentQuestion = event.data;
				console.log("question data to parse: " + event.data);
				var data = JSON.parse(event.data);
				currentQuestion = data.question;
				currentAnswer = data.answer;				
				console.log("New question: " + currentQuestion);				
				document.getElementById("question").innerHTML = "<b>Question: </b>" + currentQuestion;
				document.getElementById("answer").innerHTML = "<b>Réponse: </b>";				
				//document.getElementById("next").value = "Autre question";

				//de-activate answers buttons
				$("#correct").prop('disabled', true);
				$("#incorrect").prop('disabled', true);

			}, false);			
		}

		function glowReset(){
			var playersEl = document.querySelectorAll(".glow");
			for (var i = 0; i < playersEl.length; i++) {
				playersEl[i].classList.remove("glow");
			}
		}
		
		function listenPlayer(source){
			// Event listener for faster player
			console.log("Listening for fastest player..");
			source.addEventListener("fastest_player",function(event){

				document.getElementById("result").innerHTML = "Last browser Player sync: " + getDate() + "<br>";
				document.getElementById("result").innerHTML += "Data brute: " + event.data + "<br>";

				console.log("Fastest player: " + event.data);
				// message in JSON format
				var data = JSON.parse(event.data);
				currentPlayerID = data["player_id"]+1;//+1 to get ids indexed from 1
				currentPlayerName = data["player_name"];
				//var currentAnswer = data.answer;
												
				document.getElementById("answer").innerHTML = "<b>Réponse: </b>" + currentAnswer;
				document.getElementById("result").innerHTML += "Joueur " + currentPlayerID + " a la main.<br>";
				document.getElementById("result").innerHTML += "Réponse: " + currentAnswer + "<br>";


				//activate answers buttons
				$("#correct").prop('disabled', false);
				$("#incorrect").prop('disabled', false);

				//replace text
				//$("#player1").text("A toi");
				//Remove all glow style
				//Salut Thib, ça roule ? :)
				glowReset();
				//Add glow style to current player
				var thePlayerEl = document.querySelector("#player" + currentPlayerID );
				thePlayerEl.classList.add("glow");

				//Close connection
				//closeConnection(source); 

			}, false);
		}


		function nextQ(){
			//alert ("à implémenter :)");
			glowReset();
			console.log("Other question");
			$("#correct").prop('disabled', true);
			$("#incorrect").prop('disabled', true);
			$.ajax({url: "http://"+ document.location.hostname +":10003"});
			//startListeners();//do we need this ? as they are started from start_game button
		}		

		//async function correct(){
		function correct(){
			console.log("Correct answer");
			glowReset();
			$("#correct").prop('disabled', true);
			$("#incorrect").prop('disabled', true);	
			$.ajax({url: "http://"+ document.location.hostname +":10001"});
			//addPoints();
			//console.log('Taking a break...');
			//await sleep(1000);
			//console.log('One second later');
			//startListeners();//do we need this ? as they are started from start_game button
			//les messages de fastest player semblent arriver en double.. why ? 
			//on doit probablement avoir des connexions redondantes.
		}

		function incorrect(){
			console.log("Incorrect answer, next player");
			glowReset();
			$("#correct").prop('disabled', true);
			$("#incorrect").prop('disabled', true);
			$.ajax({url: "http://"+ document.location.hostname +":10002"});
			//startListeners();//do we need this ? as they are started from start_game button
		}
		
		/*@Nikos
		  Pay attention !!!  the interface may have been disconnected or refreshed !
		  Please use the score information contained in each status message to update scores
		  Please do it for all players for safety
		  not sure the display has to be updated if no changes are detected 
		  (it probably slows down the app and perhaps make some visual artefacts)
		  */
		function addPoints(){

			//var curWidth = $("#pb" + currentPlayerID).width();
			//var parentWidth = $("#pb" + currentPlayerID).offsetParent().width();
			//var curPoints = 100*curWidth/parentWidth;
			//currentPlayerID=1;
			var curPoints = Math.round($("#pb" + currentPlayerID).width() / $("#pb" + currentPlayerID).parent().width() * 100);
			document.getElementById("result").innerHTML += "Points actuel: " + curPoints + "<br>";
			var newPoints = curPoints + 20;
			//alert (newPoints);
			if (newPoints <= 100) {
				document.getElementById("result").innerHTML += "Nouveaux points: " + newPoints + "<br>";	
				document.getElementById("pb" + currentPlayerID).innerHTML = newPoints;
				// in jQuery
				$("#pb" + currentPlayerID).css("width", newPoints + "%");					
			}
			if (newPoints >= 100) {	
				$("#pg" + currentPlayerID).removeClass("active");
			}
		}

		
		function updateScore(player, score){

			//var curWidth = $("#pb" + currentPlayerID).width();
			//var parentWidth = $("#pb" + currentPlayerID).offsetParent().width();
			//var curPoints = 100*curWidth/parentWidth;
			//currentPlayerID=1;
			var curScore = Math.round($("#pb" + player).width() / $("#pb" + player).parent().width() * 100);
			document.getElementById("result").innerHTML += "Points actuel: " + curScore + "<br>";
			//alert (newPoints);
			var maxScore = 10;
			score = score/maxScore*100;
			if (score == curScore){
				return;
			}
			if (score <= 100) {
				document.getElementById("result").innerHTML += "Nouveaux points: " + score + "<br>";
				console.log("update score player id "+player+" to score "+score)				
				document.getElementById("pb" + player).innerHTML = score;
				// in jQuery
				$("#pb" + player).css("width", score + "%");					
			}
			if (score >= 100) {	
				$(".progress").removeClass("active");
			        $("#nextQ").addClass("hidden");
			        document.getElementById("startStop").innerHTML = "On joue encore ?";
        			document.getElementById("startStop").onclick = startGame;	
			}
		}
	

		/*
		 *@ Nikos : Use this fucking function to change the name of a player.  
		 *I sait fucking function as it forced me to change a lot in server side to allow cross-site POST method
		 *indeed Chrome first sends OPTION HTML request to know if POST will succeed in CORS context. 
		 *So I had to reply correctly to the OPTION Request first
		 *The remove player function should be implemented similarly (the definition is in restApi.py, do not change python side plz)
		*/
		function change_name(player_id, new_name){
			console.log("change name : player"+player_id+" new_name "+new_name);
			json_data=JSON.stringify({"command":"set_name","args":{"id":player_id,"name":new_name}});
			$.ajax({method: 'POST',
					url: "http://"+ document.location.hostname +":10005",
					dataType: 'json',
					contentType: "application/json; charset=utf-8",
					data: json_data});
			return;
			//startListeners();//do we need this ? as they are started from start_game button
		}
	</script>

	<script>
	// AJAX section to handle events from client's side
		// jQuery to catch any button click
		/*
		$(document).ready(function(){
		    $('.button').click(function(){
		    	alert("button clicked");

		        var clickBtnValue = $(this).val();
		        var ajaxurl = 'pig.php',
		        data =  {'action': clickBtnValue};
		        $.post(ajaxurl, data, function (response) {
		            // Response div goes here.
		            alert("action performed successfully");
		        });
		    });

		});	*/

	</script>

	<script>
		function timer(n) {
			var rand = randomIntFromInterval(1, 6);
			//$(".progress-bar").css("width", n + "%");
			$("#pb" + rand).css("width", n + "%");
			$("#pourcentage").text(n + "%");
			if (n < 100) {
				setTimeout(function() {
					timer(n + 10);
				}, 1000);
			}
		}
		function randomIntFromInterval(min, max) {
			return Math.floor(Math.random() * (max - min + 1) + min);
		}
		$(function() {
			$("#animer").click(function() {
				timer(0);
			});
		});
	</script>

	<!-- Bootstrap core JavaScript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<!--  jquery ..for later
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script> -->
    <script src="dist/js/bootstrap.min.js"></script>
	<!-- IE10 viewport hack for Surface/desktop Windows 8 bug 
	<script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>-->

	<!-- For PhoneGap build
	<script type="text/javascript">
            app.initialize();
    </script>
-->
</body>
</html>





